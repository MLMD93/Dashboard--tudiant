<!DOCTYPE html>
<html lang="fr" class="dark-mode theme-teal">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Personnel - Analytique V5 (Patch√©)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Montserrat:wght@700;800;900&display=swap');
        :root {
            --accent-500: #14B8A6; /* teal-500 */
            --accent-600: #0D9488; /* teal-600 */
            --accent-300: #5EEAD4; /* teal-300 */
        }
        .theme-yellow { --accent-500: #F59E0B; --accent-600: #D97706; --accent-300: #FCD34D; }
        .theme-blue { --accent-500: #6366F1; --accent-600: #4F46E5; --accent-300: #818CF8; }
        .theme-green { --accent-500: #10B981; --accent-600: #059669; --accent-300: #34D399; }
        .theme-rose { --accent-500: #F472B6; --accent-600: #EC4899; --accent-300: #F8A1E3; }

        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        h1,h2,h3 { font-family: 'Montserrat', sans-serif; }
        .bg-accent-500 { background-color: var(--accent-500); }
        .hover\:bg-accent-600:hover { background-color: var(--accent-600); }
        .text-accent-300 { color: var(--accent-300); }
        .text-accent-500 { color: var(--accent-500); }
        .border-accent-500 { border-color: var(--accent-500); }
        .task-done { text-decoration: line-through; opacity: 0.6; transition: all .3s ease; }
        .grade-bar-container { height: 10px; background-color: #374151; border-radius: 5px; overflow: hidden; }
        .grade-bar { height: 100%; transition: width .5s ease-in-out; background-color: var(--accent-500); }
        .today { border: 2px solid var(--accent-500) !important; font-weight: bold; background-color: #1f2937 !important; }
        #timer-display { font-size: 3rem; font-weight: 700; color: var(--accent-300); transition: color .5s; }
        .modal { z-index: 1000; background-color: rgba(0,0,0,.75); }
        .event-dot { position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 5px; height: 5px; border-radius: 50%; }
        @keyframes pulse-accent { 0%,100%{ background-color: var(--accent-500); opacity:1 } 50%{ background-color: var(--accent-600); opacity:.5 } }
        .active-task-indicator { animation: pulse-accent 1.5s infinite; background-color: var(--accent-500) !important; }

        /* Toasts */
        #toast-container { position: fixed; right: 1rem; bottom: 1rem; z-index: 2000; display: flex; flex-direction: column; gap: .5rem; }
        .toast { background: #111827; color: #fff; padding: .75rem 1rem; border-radius: .5rem; box-shadow: 0 6px 18px rgba(0,0,0,.6); border-left: 4px solid var(--accent-500); }
        .toast.success { border-left-color: #34D399; }
        .toast.warn { border-left-color: #F59E0B; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }

    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 sm:p-8">

    <div id="loading-indicator" class="fixed inset-0 bg-gray-900/80 flex items-center justify-center z-50" role="alert" aria-live="assertive">
        <div class="text-xl text-accent-300">Chargement de la configuration...<div class="animate-spin rounded-full h-8 w-8 border-b-2 border-accent-300 mx-auto mt-2"></div></div>
    </div>

    <header class="mb-8">
        <h1 class="text-4xl font-extrabold text-white tracking-tight">Mon Dashboard Personnel</h1>
        <p class="mt-2 text-gray-300">G√®re tes notes, tes t√¢ches, tes jours et ton temps de mani√®re critique.</p>
        <div class="mt-4 text-sm bg-gray-800 p-3 rounded-lg shadow-inner"><span class="font-medium text-accent-300">Bienvenue :</span>
            <code id="user-display-name" class="block mt-1 text-gray-300 overflow-auto whitespace-nowrap">Chargement...</code>
        </div>
        <div class="mt-4">
            <button id="request-notification-permission-btn" class="bg-gray-700 hover:bg-gray-600 text-sm py-1 px-3 rounded-md transition duration-150 text-gray-300 flex items-center space-x-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                <span>Activer Notifications</span>
            </button>
            <button id="open-settings-btn" class="ml-4 bg-gray-700 hover:bg-gray-600 text-sm py-1 px-3 rounded-md transition duration-150 text-gray-300 flex items-center space-x-1">Param√®tres</button>
            <button id="export-json-btn" class="ml-4 bg-blue-600 hover:bg-blue-700 text-sm py-1 px-3 rounded-md text-white">Exporter JSON</button>
            <label for="import-json-input" class="ml-2 bg-gray-700 hover:bg-gray-600 text-sm py-1 px-3 rounded-md text-white cursor-pointer">Importer JSON<input id="import-json-input" type="file" accept="application/json" class="sr-only"></label>
        </div>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-6">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl flex flex-col items-center justify-center transition duration-300 hover:shadow-accent-500/30">
            <h2 class="text-2xl font-semibold mb-4 text-white">Timer de Concentration</h2>
            <p id="timer-status" class="text-lg mb-4 font-medium text-accent-500 text-center">Pr√™t pour le Travail (25 min)</p>
            <p id="current-focus-display" class="text-sm text-gray-400 mb-2 h-4 overflow-hidden text-center">Aucun focus d√©fini.</p>
            <div id="timer-display" class="mb-6">25:00</div>
            <div class="flex space-x-4">
                <button id="timer-start-pause-btn" class="bg-accent-500 hover:bg-accent-600 text-gray-900 font-bold py-3 px-6 rounded-full shadow-lg">D√©marrer</button>
                <button id="timer-reset-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-full shadow-lg">R√©initialiser</button>
            </div>
            <button id="set-focus-btn" class="mt-4 text-sm text-blue-400 hover:text-blue-500">Associer √† une t√¢che...</button>
        </div>

        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl xl:col-span-2">
            <h2 class="text-2xl font-semibold mb-4 text-white">T√¢ches √† Faire</h2>
            <div class="flex mb-4">
                <input type="text" id="todo-input" class="flex-grow p-2 rounded-l-lg bg-gray-700 text-white border-2 border-gray-700 placeholder-gray-400" placeholder="Ajouter une t√¢che..." maxlength="100">
                <button id="add-todo-btn" title="Ajouter une t√¢che" aria-label="Ajouter une t√¢che" class="bg-accent-500 hover:bg-accent-600 text-gray-900 font-bold py-2 px-4 rounded-r-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span class="sr-only">Ajouter une t√¢che</span>
                </button>
            </div>
            <ul id="todo-list-container" class="space-y-2 max-h-56 overflow-y-auto pr-2" aria-live="polite"></ul>
            <p id="empty-list-message" class="text-gray-400 text-center mt-4 hidden">Rien √† faire, le repos est m√©rit√© !</p>
        </div>

        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-semibold mb-4 text-white">Notes & Progr√®s</h2>
            <div class="mb-4 p-3 bg-gray-700 rounded-lg text-center">
                <p class="text-sm text-gray-400">Moyenne G√©n√©rale Actuelle</p>
                <p id="overall-gpa" class="text-4xl font-extrabold text-accent-300">--/20</p>
            </div>
            <div id="grades-container" class="space-y-4 max-h-56 overflow-y-auto pr-2"></div>
            <div class="mt-4 border-t border-gray-700 pt-4"><button id="add-grade-btn-modal" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg">Ajouter Mati√®re</button></div>
        </div>

        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-semibold mb-4 text-white flex justify-between items-center">Note Rapide <span id="save-status" class="text-xs text-gray-400">Pr√™t</span></h2>
            <textarea id="personal-note" class="w-full h-48 p-3 rounded-lg bg-gray-700 text-white border-2 border-gray-700 resize-none" placeholder="√âcris tes pens√©es ou rappels rapides ici."></textarea>
        </div>

        <div class="lg:col-span-2 xl:col-span-3 bg-gray-800 p-6 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-semibold mb-4 text-white flex justify-between items-center">Calendrier & Deadlines <button id="add-deadline-btn-modal" class="text-sm bg-accent-500 hover:bg-accent-600 text-gray-900 font-bold py-1 px-3 rounded-full">üóìÔ∏è + Deadline</button></h2>
            <div class="text-center text-xl font-bold mb-4 text-white" id="month-year-display"></div>
            <div class="grid grid-cols-7 text-center text-sm font-medium text-gray-400 mb-2"><span>Lun</span><span>Mar</span><span>Mer</span><span>Jeu</span><span>Ven</span><span class="text-red-400">Sam</span><span class="text-red-400">Dim</span></div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
            <div class="mt-4 pt-4 border-t border-gray-700"><h3 class="text-xl font-semibold mb-2 text-white">Prochains √âv√©nements</h3><ul id="event-list" class="space-y-2"></ul></div>
        </div>

    </main>

    <div id="settings-modal" class="modal fixed inset-0 hidden items-center justify-center p-4"><div class="modal-content bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-lg">
        <h3 class="text-2xl font-bold mb-4 text-white">‚öôÔ∏è Param√®tres</h3>
        <div class="space-y-6">
            <section>
                <h4 class="text-xl font-semibold mb-3 text-accent-300">Mon Nom</h4>
                <div><label for="user-custom-name" class="block text-sm text-gray-300">Nom ou Surnom</label>
                <input id="user-custom-name" class="w-full p-3 mt-1 rounded-lg bg-gray-700 text-white border-2 border-gray-700" placeholder="Ex: Lawali, Maman, Champion"><button id="save-user-name-btn" class="mt-2 bg-gray-700 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded-lg">Enregistrer</button></div>
            </section>
            <section>
                <h4 class="text-xl font-semibold mb-3 text-accent-300">Couleur d'Accent (Th√®me)</h4>
                <div class="flex space-x-4">
                    <button class="w-12 h-12 rounded-full theme-selector bg-teal-500" data-theme="theme-teal" title="Teal"></button>
                    <button class="w-12 h-12 rounded-full theme-selector bg-yellow-500" data-theme="theme-yellow" title="Jaune"></button>
                    <button class="w-12 h-12 rounded-full theme-selector bg-blue-500" data-theme="theme-blue" title="Indigo"></button>
                    <button class="w-12 h-12 rounded-full theme-selector bg-emerald-500" data-theme="theme-green" title="Vert"></button>
                    <button class="w-12 h-12 rounded-full theme-selector bg-rose-500" data-theme="theme-rose" title="Rose"></button>
                </div>
                <p class="text-xs text-gray-400 mt-2">Le mode sombre reste actif.</p>
            </section>
        </div>
        <div class="flex justify-end mt-6"><button onclick="closeModal('settings-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Fermer</button></div>
    </div></div>

    <div id="add-grade-modal" class="modal fixed inset-0 hidden items-center justify-center p-4"><div class="modal-content bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-lg">
        <h3 class="text-2xl font-bold mb-4 text-white">Ajouter une Mati√®re</h3>
        <form id="add-grade-form" class="space-y-4"><div><label for="new-grade-name" class="text-sm text-gray-300">Nom</label><input id="new-grade-name" required title="Nom de la mati√®re" placeholder="Ex: Algorithmique (INF101)" class="w-full p-3 mt-1 rounded-lg bg-gray-700 text-white border-2 border-gray-700"></div>
        <div><label for="new-grade-weight" class="text-sm text-gray-300">Coefficient</label><input id="new-grade-weight" type="number" required min="1" value="3" title="Coefficient (entier sup√©rieur √† 0)" placeholder="3" class="w-full p-3 mt-1 rounded-lg bg-gray-700 text-white border-2 border-gray-700"></div>
        <div><label for="new-grade-score" class="text-sm text-gray-300">Note (0-20)</label><input id="new-grade-score" type="number" required min="0" max="20" step="0.1" value="10.0" title="Note entre 0 et 20" placeholder="10.0" class="w-full p-3 mt-1 rounded-lg bg-gray-700 text-white border-2 border-gray-700"></div>
        <div class="flex justify-end space-x-3 mt-6"><button type="button" onclick="closeModal('add-grade-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Annuler</button><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Ajouter</button></div></form>
    </div></div>

    <div id="add-deadline-modal" class="modal fixed inset-0 hidden items-center justify-center p-4"><div class="modal-content bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-lg">
        <h3 class="text-2xl font-bold mb-4 text-white">Ajouter une Deadline</h3>
        <form id="add-deadline-form" class="space-y-4"><div><label for="new-deadline-description" class="text-sm text-gray-300">Description</label><input id="new-deadline-description" required title="Description de la deadline" placeholder="Ex: Projet rendu" class="w-full p-3 mt-1 rounded-lg bg-gray-700 text-white border-2 border-gray-700"></div>
        <div><label for="new-deadline-date" class="text-sm text-gray-300">Date</label><input id="new-deadline-date" type="date" required title="Date de la deadline (AAAA-MM-JJ)" placeholder="YYYY-MM-DD" class="w-full p-3 mt-1 rounded-lg bg-gray-700 text-white border-2 border-gray-700"></div>
        <div class="flex justify-end space-x-3 mt-6"><button type="button" onclick="closeModal('add-deadline-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Annuler</button><button type="submit" class="bg-accent-500 hover:bg-accent-600 text-gray-900 font-bold py-2 px-4 rounded-lg">Planifier</button></div></form>
    </div></div>

    <div id="set-focus-modal" class="modal fixed inset-0 hidden items-center justify-center p-4"><div class="modal-content bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-lg">
        <h3 class="text-2xl font-bold mb-4 text-white">Choisir la T√¢che (Focus)</h3><p class="text-sm text-gray-400 mb-4">Le temps Pomodoro sera cr√©dit√© √† cette t√¢che.</p>
        <ul id="focus-task-list" class="space-y-2 max-h-64 overflow-y-auto pr-2"></ul>
        <div class="flex justify-end space-x-3 mt-6"><button onclick="closeModal('set-focus-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Fermer</button><button id="clear-focus-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Retirer le Focus</button></div>
    </div></div>

    <div id="day-events-modal" class="modal fixed inset-0 hidden items-center justify-center p-4"><div class="modal-content bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-lg">
        <h3 id="day-events-title" class="text-2xl font-bold mb-4 text-white">√âv√©nements du Jour</h3><ul id="day-events-list" class="space-y-3"></ul><div class="flex justify-end mt-6"><button onclick="closeModal('day-events-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Fermer</button></div>
    </div></div>

    <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

    <script>
    /* --------------------------------------------------
       Utilities & Safe date helpers
       -------------------------------------------------- */
    (function(){
        'use strict';

        const STORAGE_KEYS = {
            theme: 'userTheme', name: 'userName', note: 'studentDashboardNote', tasks: 'studentDashboardTasks', grades: 'studentDashboardGrades', deadlines: 'studentDashboardDeadlines'
        };

        function qs(id){ return document.getElementById(id); }

        function dateToYMD(d){ // returns 'YYYY-MM-DD' in local timezone
            const y = d.getFullYear();
            const m = String(d.getMonth()+1).padStart(2,'0');
            const day = String(d.getDate()).padStart(2,'0');
            return `${y}-${m}-${day}`;
        }

        function parseYMDToLocalDate(ymd){ // interpret 'YYYY-MM-DD' as local date at midday to avoid TZ shift
            if(!ymd) return null;
            const [y,m,d] = ymd.split('-').map(Number);
            return new Date(y, m-1, d, 12, 0, 0, 0);
        }

        // Toasts (non-blocking notifications)
        const toastContainer = qs('toast-container');
        function showToast(message, opts={type:'default', timeout:3500}){
            const t = document.createElement('div');
            t.className = 'toast ' + (opts.type || '');
            t.setAttribute('role','status');
            t.textContent = message;
            toastContainer.appendChild(t);
            if(opts.timeout !== 0){ setTimeout(()=>{ t.style.opacity='0'; setTimeout(()=>t.remove(),400); }, opts.timeout); }
            return t;
        }

        // Non-blocking confirm: returns a Promise resolved true/false
        function confirmNonBlocking(message, opts={okText:'Oui', cancelText:'Non'}){
            return new Promise(resolve => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 flex items-center justify-center modal';
                modal.innerHTML = `<div class="bg-gray-800 p-6 rounded-lg shadow-lg max-w-md text-white"><p class="mb-4">${message}</p><div class="flex justify-end gap-3"><button class="bg-gray-600 hover:bg-gray-700 py-1 px-3 rounded">${opts.cancelText}</button><button class="bg-accent-500 hover:bg-accent-600 text-gray-900 font-bold py-1 px-3 rounded">${opts.okText}</button></div></div>`;
                document.body.appendChild(modal);
                const [cancelBtn, okBtn] = modal.querySelectorAll('button');
                cancelBtn.addEventListener('click', ()=>{ modal.remove(); resolve(false); });
                okBtn.addEventListener('click', ()=>{ modal.remove(); resolve(true); });
            });
        }

        // Safe localStorage wrappers
        function safeGet(key){ try{ return localStorage.getItem(key); }catch(e){ console.error('localStorage.get failed',e); return null; } }
        function safeSet(key, value){ try{ localStorage.setItem(key, value); return true; }catch(e){ console.error('localStorage.set failed',e); showToast('Impossible de sauvegarder localement (stockage plein?)', {type:'warn'}); return false; } }

        /* --------------------------------------------------
           Preferences & Theme
           -------------------------------------------------- */
        const DEFAULT_THEME = 'theme-teal';
        const DEFAULT_NAME = 'Utilisateur (ID: U_MAMAN_L_2025_42)';

        function getPreferences(){ return { theme: safeGet(STORAGE_KEYS.theme) || DEFAULT_THEME, name: safeGet(STORAGE_KEYS.name) || DEFAULT_NAME }; }

        function applyPreferences(){
            const prefs = getPreferences();
            // remove any theme-* classes and add selected
            document.documentElement.classList.remove('theme-teal','theme-yellow','theme-blue','theme-green','theme-rose');
            document.documentElement.classList.add('dark-mode');
            document.documentElement.classList.add(prefs.theme);
            qs('user-display-name').textContent = prefs.name;
            const customNameInput = qs('user-custom-name'); if(customNameInput) customNameInput.value = (prefs.name === DEFAULT_NAME ? '' : prefs.name);
            // update timer color (CORRECTION 2.2: Removed parameter)
            updateTimerColor();
        }

        function saveTheme(theme){ safeSet(STORAGE_KEYS.theme, theme); applyPreferences(); showToast('Th√®me appliqu√©'); }
        function saveName(){ const input = qs('user-custom-name'); const newName = input.value.trim(); const final = newName === '' ? DEFAULT_NAME : newName; safeSet(STORAGE_KEYS.name, final); applyPreferences(); showToast('Nom enregistr√©'); }

        // CORRECTION 2.1: Simplified function to always read from computed style
        function updateTimerColor(){
            // Reads the current theme's --accent-300 color defined in CSS
            qs('timer-display').style.color = getComputedStyle(document.documentElement).getPropertyValue('--accent-300') || '#5EEAD4';
        }

        /* --------------------------------------------------
           Toast-backed Notification fallback
           -------------------------------------------------- */
        function notify(title, body){
            if('Notification' in window && Notification.permission === 'granted'){
                new Notification(title, { body, icon: 'https://img.icons8.com/color/48/000000/hourglass-time-delay.png' });
            } else {
                showToast(`${title} ‚Äî ${body}`, {type:'success', timeout: 5000});
            }
        }

        /* --------------------------------------------------
           Pomodoro Timer
           -------------------------------------------------- */
        const WORK_TIME = 25*60, SHORT_BREAK_TIME = 5*60, LONG_BREAK_TIME = 15*60, POMODORO_CYCLES = 4;
        let timer = null, isRunning=false, timeLeft=WORK_TIME, currentMode='work', pomodoroCount=0, currentFocusId = null;

        function updateDisplay(){ const minutes = Math.floor(timeLeft/60); const seconds = timeLeft%60; document.title = `(${minutes}:${seconds<10?'0':''}${seconds}) - Dashboard`; qs('timer-display').textContent = `${minutes<10?'0':''}${minutes}:${seconds<10?'0':''}${seconds}`; }

        function updateFocusDisplay(){ const tasks = getTasks(); const focus = tasks.find(t=>t.id===currentFocusId); qs('current-focus-display').textContent = focus ? `Focus: ${focus.text}` : 'Aucun focus d√©fini.'; }

        function creditFocusTime(){ if(!currentFocusId) return; const tasks = getTasks(); const idx = tasks.findIndex(t=>t.id===currentFocusId); if(idx !== -1){ tasks[idx].timeSpent = (tasks[idx].timeSpent||0) + WORK_TIME/60; saveTasks(tasks); renderTasks(); notify('Cycle Termin√© !', `${WORK_TIME/60} minutes cr√©dit√©es √† "${tasks[idx].text}".`); } }

        // CORRECTION 1.1: Removed auto-restart (startTimer()) to force user confirmation/pause between modes
        async function changeMode(){ 
            if(currentMode === 'work'){ 
                creditFocusTime(); pomodoroCount++; 
                if(pomodoroCount % POMODORO_CYCLES === 0){ 
                    currentMode='long-break'; 
                    timeLeft=LONG_BREAK_TIME; 
                    qs('timer-status').textContent = `Longue Pause (${LONG_BREAK_TIME/60} min) - ${pomodoroCount} cycles`; 
                    updateTimerColor(); // Set break color
                    notify('Longue Pause !','F√©licitations pour 4 cycles.'); 
                } else { 
                    currentMode='short-break'; 
                    timeLeft=SHORT_BREAK_TIME; 
                    qs('timer-status').textContent = `Petite Pause (${SHORT_BREAK_TIME/60} min) - ${pomodoroCount} cycles`; 
                    updateTimerColor(); // Set break color
                    notify('Petite Pause !','Rafra√Æchis-toi.'); 
                }
            } else { 
                currentMode='work'; 
                timeLeft=WORK_TIME; 
                qs('timer-status').textContent = `Concentration #${pomodoroCount+1} (${WORK_TIME/60} min)`; 
                updateTimerColor(); // Set work color
                notify('Retour au Travail !','Bonne session.'); 
            }
            
            // The timer is already paused by countdown() calling clearInterval. 
            // We just update the display to show the new time.
            updateDisplay();
        }

        function countdown(){ 
            timeLeft--; updateDisplay(); 
            if(timeLeft <= 0){ 
                clearInterval(timer); 
                isRunning=false; 
                qs('timer-start-pause-btn').textContent = 'D√©marrer'; 
                changeMode(); 
            } 
        }

        async function startTimer(){
            if(currentMode === 'work' && !currentFocusId){ 
                const ok = await confirmNonBlocking('Tu n\'as pas associ√© de t√¢che √† ce cycle. Le temps ne sera pas enregistr√©. Continuer ?');
                if(!ok) return;
            }
            if(!isRunning){ isRunning=true; qs('timer-start-pause-btn').textContent='Pause'; timer = setInterval(countdown, 1000);} else { isRunning=false; qs('timer-start-pause-btn').textContent='Continuer'; clearInterval(timer); }
        }

        function resetTimer(){ clearInterval(timer); isRunning=false; pomodoroCount=0; currentMode='work'; timeLeft=WORK_TIME; qs('timer-start-pause-btn').textContent='D√©marrer'; qs('timer-status').textContent = `Pr√™t pour le Travail (${WORK_TIME/60} min)`; updateTimerColor(); document.title = 'Dashboard Personnel'; updateDisplay(); }

        /* --------------------------------------------------
           Notes rapides
           -------------------------------------------------- */
        const personalNoteEl = qs('personal-note'); const saveStatus = qs('save-status'); let saveTimeout;
        function saveNote(){ safeSet(STORAGE_KEYS.note, personalNoteEl.value); saveStatus.textContent='Sauvegard√© !'; saveStatus.classList.add('text-green-400'); setTimeout(()=>{ saveStatus.textContent='Pr√™t'; saveStatus.classList.remove('text-green-400'); },1500); }
        function handleNoteInput(){ clearTimeout(saveTimeout); saveStatus.textContent='√âcriture...'; saveTimeout = setTimeout(saveNote, 500); }

        /* --------------------------------------------------
           Tasks (localStorage)
           -------------------------------------------------- */
        function getTasks(){ const raw = safeGet(STORAGE_KEYS.tasks); return raw ? JSON.parse(raw) : []; }
        function saveTasks(tasks){ safeSet(STORAGE_KEYS.tasks, JSON.stringify(tasks)); }
        function updateEmptyMessage(tasks){ tasks.length===0 ? qs('empty-list-message').classList.remove('hidden') : qs('empty-list-message').classList.add('hidden'); }
        function formatTime(totalMinutes){ if(!totalMinutes || totalMinutes===0) return ''; const hours=Math.floor(totalMinutes/60); const minutes=totalMinutes%60; let out='('; if(hours>0) out+=`${hours}h `; if(minutes>0) out+=`${minutes}m`; return out.trim()+')'; }

        function renderTasks(){ const tasks = getTasks(); const container = qs('todo-list-container'); container.innerHTML=''; tasks.forEach((task, index)=>{
            const li = document.createElement('li'); li.className='flex items-center justify-between p-3 bg-gray-700 rounded-lg shadow-sm group';
            const focusIndicator = document.createElement('div'); focusIndicator.className = 'w-2 h-2 rounded-full mr-3 ' + (task.id===currentFocusId ? 'active-task-indicator' : 'bg-gray-600');
            const textContainer = document.createElement('span'); textContainer.className='flex-grow cursor-pointer p-1 flex items-center';
            const textSpan = document.createElement('span'); textSpan.textContent = task.text;
            const timeSpan = document.createElement('span'); timeSpan.textContent = formatTime(task.timeSpent); timeSpan.className='text-xs text-accent-300 ml-1 font-mono';
            textContainer.appendChild(textSpan); textContainer.appendChild(timeSpan);
            if(task.completed) textContainer.classList.add('task-done'); textContainer.addEventListener('click', ()=> toggleComplete(index));
            const actions = document.createElement('div'); actions.className='flex items-center space-x-2 ml-4 opacity-0 group-hover:opacity-100';
            const editBtn = document.createElement('button'); editBtn.innerHTML='‚úèÔ∏è'; editBtn.title='Modifier'; editBtn.addEventListener('click',(e)=>{ e.stopPropagation(); editTask(index); });
            actions.appendChild(editBtn);
            if((task.timeSpent||0) >= WORK_TIME/60){ const deBtn = document.createElement('button'); deBtn.textContent = `- ${WORK_TIME/60}m`; deBtn.className='text-red-400 p-1'; deBtn.addEventListener('click',(e)=>{ e.stopPropagation(); deCreditTime(index); }); actions.appendChild(deBtn); }
            const delBtn = document.createElement('button'); delBtn.innerHTML='üóëÔ∏è'; delBtn.title='Supprimer'; delBtn.addEventListener('click',(e)=>{ e.stopPropagation(); deleteTask(index); }); actions.appendChild(delBtn);
            li.appendChild(focusIndicator); li.appendChild(textContainer); li.appendChild(actions); container.appendChild(li);
        }); updateEmptyMessage(getTasks()); updateFocusDisplay(); }

        function addTask(){ const text = qs('todo-input').value.trim(); if(text==='') return; const tasks=getTasks(); const newId = Date.now(); tasks.push({ id:newId, text, completed:false, timeSpent:0 }); saveTasks(tasks); qs('todo-input').value=''; renderTasks(); }
        function editTask(index){ const tasks=getTasks(); const t=tasks[index]; const newText = prompt('Modifier la t√¢che:', t.text); if(newText!==null && newText.trim()!=='' && newText.trim()!==t.text){ t.text=newText.trim(); saveTasks(tasks); renderTasks(); updateFocusDisplay(); showToast('T√¢che modifi√©e'); } }
        function deCreditTime(index){ const tasks=getTasks(); const t=tasks[index]; if((t.timeSpent||0) >= WORK_TIME/60){ t.timeSpent = Math.max(0, t.timeSpent - WORK_TIME/60); saveTasks(tasks); renderTasks(); showToast('Temps d√©cr√©dit√©'); } }
        function toggleComplete(index){ const tasks=getTasks(); tasks[index].completed = !tasks[index].completed; if(tasks[index].id === currentFocusId && tasks[index].completed){ currentFocusId = null; updateFocusDisplay(); } saveTasks(tasks); renderTasks(); }
        async function deleteTask(index){ const tasks=getTasks(); const ok = await confirmNonBlocking(`Supprimer la t√¢che "${tasks[index].text}" ?`); if(!ok) return; if(tasks[index].id===currentFocusId) currentFocusId=null; tasks.splice(index,1); saveTasks(tasks); renderTasks(); showToast('T√¢che supprim√©e'); }

        function renderFocusModal(){ const tasks = getTasks().filter(t=>!t.completed); const list = qs('focus-task-list'); list.innerHTML=''; if(tasks.length===0){ list.innerHTML='<li class="text-gray-400 text-center py-4">Pas de t√¢ches non compl√©t√©es. Ajoute-en !</li>'; qs('clear-focus-btn').classList.add('hidden'); openModal('set-focus-modal'); return; } qs('clear-focus-btn').classList.remove('hidden'); tasks.forEach(t=>{ const li = document.createElement('li'); li.className='flex items-center justify-between p-3 rounded-lg cursor-pointer hover:bg-gray-700'; const isSelected = t.id === currentFocusId; li.innerHTML = `<span>${t.text} ${formatTime(t.timeSpent)}</span><button class="text-sm ${isSelected ? 'text-accent-300' : 'text-blue-400'} font-bold">${isSelected ? 'FOCUS ACTIF' : 'Choisir'}</button>`; li.querySelector('button').addEventListener('click', ()=>{ currentFocusId = t.id; updateFocusDisplay(); renderTasks(); closeModal('set-focus-modal'); }); list.appendChild(li); }); openModal('set-focus-modal'); }

        /* --------------------------------------------------
           Grades
           -------------------------------------------------- */
        function getDefaultGrades(){ return [{ id:1, name:'Algorithmique (INF101)', grade:16.2, weight:5 }, { id:2, name:'Analyse (MAT105)', grade:11.0, weight:4 }]; }
        function getGrades(){ const raw = safeGet(STORAGE_KEYS.grades); return raw ? JSON.parse(raw) : getDefaultGrades(); }
        function saveGrades(grades){ safeSet(STORAGE_KEYS.grades, JSON.stringify(grades)); }
        function calculateOverallGPA(grades){ if(grades.length===0) return {gpa:0,totalWeight:0}; let totalScore=0, totalWeight=0; grades.forEach(g=>{ totalScore += parseFloat(g.grade) * parseInt(g.weight); totalWeight += parseInt(g.weight); }); const gpa = totalWeight>0 ? (totalScore/totalWeight) : 0; return { gpa: gpa.toFixed(1), totalWeight }; }

        function createGradeElement(gradeItem,index){ const div = document.createElement('div'); div.className='space-y-1 group'; const percentage = (gradeItem.grade/20)*100; const barColor = percentage >=50 ? 'bg-accent-500' : 'bg-red-500'; div.innerHTML = `<div class="flex justify-between items-center text-sm font-medium"><span title="Coefficient: ${gradeItem.weight}">${gradeItem.name} (Coef: ${gradeItem.weight})</span><div class="flex items-center space-x-2"><input type="number" min="0" max="20" step="0.1" value="${gradeItem.grade}" data-index="${index}" class="w-16 text-right bg-gray-700 text-accent-300 rounded-md p-1" aria-label="Note pour ${gradeItem.name}"/><div class="flex opacity-0 group-hover:opacity-100 transition duration-300"><button class="text-blue-400 hover:text-blue-500 text-xs px-1" onclick="window.modifyGrade(${index})">‚úèÔ∏è</button><button class="text-red-400 hover:text-red-500 text-xs px-1" onclick="window.deleteGrade(${index})">üóëÔ∏è</button></div></div></div><div class="grade-bar-container"><div class="grade-bar ${barColor}" style="width: ${percentage}%;"></div></div>`; return div; }

        function renderGrades(){ const grades = getGrades(); const container = qs('grades-container'); container.innerHTML=''; if(grades.length===0){ qs('no-grades-message') && qs('no-grades-message').classList.remove('hidden'); qs('overall-gpa').textContent='--/20'; return; } qs('no-grades-message') && qs('no-grades-message').classList.add('hidden'); grades.forEach((g,i)=> container.appendChild(createGradeElement(g,i))); container.querySelectorAll('input[type="number"]').forEach(input=>{ input.addEventListener('change', handleGradeChange); input.addEventListener('focus', e=> e.target.select()); }); const { gpa } = calculateOverallGPA(grades); qs('overall-gpa').textContent = `${gpa}/20`; }

        function handleGradeChange(e){ let newGrade = parseFloat(e.target.value); const index = parseInt(e.target.dataset.index); if(isNaN(newGrade) || newGrade < 0) newGrade = 0; if(newGrade > 20) newGrade = 20; e.target.value = newGrade.toFixed(1); const grades = getGrades(); grades[index].grade = newGrade; saveGrades(grades); renderGrades(); }

        window.modifyGrade = function(index){ const grades = getGrades(); const current = grades[index]; const newName = prompt(`Modifier le nom (Actuel: ${current.name}) :`, current.name); if(newName===null) return; const newWeight = prompt(`Modifier le coefficient (Actuel: ${current.weight}) :`, current.weight); if(newWeight===null) return; const finalWeight = parseInt(newWeight); if(newName.trim()!=='') grades[index].name = newName.trim(); if(!isNaN(finalWeight) && finalWeight>0) grades[index].weight = finalWeight; saveGrades(grades); renderGrades(); };
        
        // CORRECTION 4: Changed blocking confirm to non-blocking confirmNonBlocking
        window.deleteGrade = function(index){ 
            confirmNonBlocking(`Supprimer la mati√®re ${getGrades()[index].name} ?`).then(ok=>{ 
                if(!ok) return; 
                const grades = getGrades(); 
                grades.splice(index,1); 
                saveGrades(grades); 
                renderGrades(); 
                showToast('Mati√®re supprim√©e'); 
            }); 
        };

        document.getElementById('add-grade-form').addEventListener('submit', (e)=>{ e.preventDefault(); const name = qs('new-grade-name').value.trim(); const weight = parseInt(qs('new-grade-weight').value); const grade = parseFloat(qs('new-grade-score').value); if(!name || isNaN(weight) || weight<=0 || isNaN(grade) || grade<0 || grade>20){ showToast('Valeurs invalides'); return; } const grades = getGrades(); grades.push({ id: Date.now(), name, grade: grade.toFixed(1), weight }); saveGrades(grades); renderGrades(); closeModal('add-grade-modal'); e.target.reset(); });

        /* --------------------------------------------------
           Calendar & Deadlines
           -------------------------------------------------- */
        function getDeadlines(){ const raw = safeGet(STORAGE_KEYS.deadlines); return raw ? JSON.parse(raw) : []; }
        function saveDeadlines(dl){ safeSet(STORAGE_KEYS.deadlines, JSON.stringify(dl)); renderCalendar(); }

        const calendarGrid = qs('calendar-grid'), monthYearDisplay = qs('month-year-display'), eventList = qs('event-list');
        const TODAY_YMD = dateToYMD(new Date());

        function renderCalendar(){ calendarGrid.innerHTML=''; const now = new Date(); const year = now.getFullYear(), month = now.getMonth(); const deadlines = getDeadlines(); const monthName = now.toLocaleString('fr-FR', { month:'long', year:'numeric' }); monthYearDisplay.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
            const firstDayOfMonth = new Date(year, month, 1); const startDayIndex = (firstDayOfMonth.getDay() + 6) % 7; const daysInMonth = new Date(year, month+1, 0).getDate(); for(let i=0;i<startDayIndex;i++){ const emptyCell = document.createElement('div'); emptyCell.className='p-2 text-gray-700'; calendarGrid.appendChild(emptyCell); }
            for(let day=1; day<=daysInMonth; day++){ const dayCell = document.createElement('div'); dayCell.className='p-2 rounded-lg cursor-pointer hover:bg-gray-700 transition duration-150 text-center relative'; dayCell.innerHTML = `<span class="font-bold">${day}</span>`; const ymd = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`; const eventsOnDay = getDeadlines().filter(d => d.date === ymd); if(ymd === TODAY_YMD) dayCell.classList.add('today'); if(eventsOnDay.length>0){ dayCell.classList.add('has-event'); dayCell.innerHTML += `<div class="event-dot" style="background-color: var(--accent-500);"></div>`; } calendarGrid.appendChild(dayCell); dayCell.addEventListener('click', ()=> showDayEvents(day, month, year, eventsOnDay)); }
            renderUpcomingEvents(getDeadlines()); }

        function renderUpcomingEvents(deadlines){ eventList.innerHTML=''; const now = new Date(); const todayMidnight = dateToYMD(now);
            const upcoming = deadlines.filter(d => d.date >= todayMidnight).sort((a,b) => a.date.localeCompare(b.date)); if(upcoming.length===0) { eventList.innerHTML = '<li class="text-sm text-gray-400">Aucune deadline planifi√©e.</li>'; return; } upcoming.slice(0,5).forEach(e => { const dateStr = parseYMDToLocalDate(e.date).toLocaleDateString('fr-FR',{ day:'numeric','month':'short' }); const li = document.createElement('li'); li.className='text-sm text-accent-300'; li.innerHTML = `<div class="flex justify-between items-center bg-gray-700 p-2 rounded-lg"><span>üìÖ ${dateStr} : ${e.description}</span><button class="text-red-400 hover:text-red-600 text-xs">üóëÔ∏è</button></div>`; li.querySelector('button').addEventListener('click', ()=> deleteDeadline(e.date, e.description)); eventList.appendChild(li); }); }

        function showDayEvents(day, month, year, events){ const title = qs('day-events-title'); const list = qs('day-events-list'); list.innerHTML=''; title.textContent = `Deadlines pour le ${day}/${month+1}/${year}`; if(events.length===0){ list.innerHTML = `<li class="text-gray-400">Aucune deadline planifi√©e. <span class="text-accent-300 cursor-pointer" onclick="prepareAddDeadline(${day}, ${month}, ${year})">Ajouter ?</span></li>`; } else { events.forEach(e=>{ const item = document.createElement('li'); item.className='flex justify-between items-center p-3 bg-gray-700 rounded-lg text-white'; item.innerHTML = `<span>${e.description}</span><button class="text-red-400 hover:text-red-600">üóëÔ∏è</button>`; item.querySelector('button').addEventListener('click', ()=> deleteDeadline(e.date, e.description, true)); list.appendChild(item); }); } openModal('day-events-modal'); }

        window.prepareAddDeadline = function(day, month, year){ closeModal('day-events-modal'); const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`; qs('new-deadline-date').value = dateStr; openModal('add-deadline-modal'); };

        function deleteDeadline(date, description, closeDayModal=false){ confirmNonBlocking(`Supprimer la deadline: "${description}" du ${date} ?`).then(ok=>{ if(!ok) return; let dls = getDeadlines(); const i = dls.findIndex(x => x.date === date && x.description === description); if(i>-1){ dls.splice(i,1); saveDeadlines(dls); renderCalendar(); if(closeDayModal) closeModal('day-events-modal'); showToast('Deadline supprim√©e'); } }); }

        document.getElementById('add-deadline-form').addEventListener('submit',(e)=>{ e.preventDefault(); const desc = qs('new-deadline-description').value.trim(); const dateInput = qs('new-deadline-date').value.trim(); if(!desc || !dateInput){ showToast('Remplis les champs'); return; } const date = parseYMDToLocalDate(dateInput); if(!date || isNaN(date.getTime())){ showToast('Date invalide'); return; } const dls = getDeadlines(); dls.push({ date: dateInput, description: desc }); saveDeadlines(dls); closeModal('add-deadline-modal'); e.target.reset(); });

        /* --------------------------------------------------
           Export / Import JSON
           -------------------------------------------------- */
        function exportAllAsJSON(){ const data = { prefs: { theme: safeGet(STORAGE_KEYS.theme), name: safeGet(STORAGE_KEYS.name) }, note: safeGet(STORAGE_KEYS.note), tasks: getTasks(), grades: getGrades(), deadlines: getDeadlines() }; const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `dashboard-backup-${dateToYMD(new Date())}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); showToast('Export termin√©'); }

        function importFromFile(file){ const reader = new FileReader(); reader.onload = (evt)=>{ try{ const parsed = JSON.parse(evt.target.result); if(parsed.prefs){ if(parsed.prefs.theme) safeSet(STORAGE_KEYS.theme, parsed.prefs.theme); if(parsed.prefs.name) safeSet(STORAGE_KEYS.name, parsed.prefs.name); } if(parsed.note) safeSet(STORAGE_KEYS.note, parsed.note); if(Array.isArray(parsed.tasks)) safeSet(STORAGE_KEYS.tasks, JSON.stringify(parsed.tasks)); if(Array.isArray(parsed.grades)) safeSet(STORAGE_KEYS.grades, JSON.stringify(parsed.grades)); if(Array.isArray(parsed.deadlines)) safeSet(STORAGE_KEYS.deadlines, JSON.stringify(parsed.deadlines)); renderAll(); showToast('Importation termin√©e'); }catch(err){ showToast('Fichier JSON invalide', {type:'warn'}); console.error(err); } } ; reader.readAsText(file); }

        /* --------------------------------------------------
           Helpers : modales, renderAll, init
           -------------------------------------------------- */
        function openModal(id){ const el=qs(id); if(!el) return; el.classList.remove('hidden'); el.classList.add('flex'); }
        function closeModal(id){ const el=qs(id); if(!el) return; el.classList.add('hidden'); el.classList.remove('flex'); }

        function renderAll(){ 
            applyPreferences(); 
            const savedNote = safeGet(STORAGE_KEYS.note); 
            if(savedNote) personalNoteEl.value = savedNote; 
            personalNoteEl.removeEventListener('input', handleNoteInput); 
            personalNoteEl.addEventListener('input', handleNoteInput); 
            renderTasks(); 
            renderGrades(); 
            renderCalendar(); 
            updateFocusDisplay(); 
        }

        // Event listeners and wiring
        document.addEventListener('DOMContentLoaded', ()=>{
            document.getElementById('loading-indicator').classList.add('hidden');
            // initial render
            renderAll();
            
            // CORRECTION 3: Re-added modal outside click close
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modal.id);
                    }
                });
            });

            // wire up buttons
            qs('timer-start-pause-btn').addEventListener('click', startTimer);
            qs('timer-reset-btn').addEventListener('click', resetTimer);
            qs('request-notification-permission-btn').addEventListener('click', ()=>{
                if(!('Notification' in window)){ showToast('Notifications non support√©es'); return; }
                Notification.requestPermission().then(p=>{ if(p==='granted'){ qs('request-notification-permission-btn').innerHTML = 'Notifications ACTIVES'; qs('request-notification-permission-btn').disabled = true; showToast('Notifications activ√©es'); } else if(p==='denied'){ qs('request-notification-permission-btn').innerHTML = 'Notifications BLOQU√âES'; qs('request-notification-permission-btn').disabled = true; showToast('Notifications bloqu√©es'); } else showToast('Permission notifications refus√©e'); });
            });

            qs('open-settings-btn').addEventListener('click', ()=> openModal('settings-modal'));
            document.querySelectorAll('.theme-selector').forEach(btn => btn.addEventListener('click', ()=> saveTheme(btn.dataset.theme)));
            qs('save-user-name-btn').addEventListener('click', saveName);

            qs('set-focus-btn').addEventListener('click', renderFocusModal);
            qs('clear-focus-btn').addEventListener('click', ()=>{ currentFocusId = null; updateFocusDisplay(); renderTasks(); closeModal('set-focus-modal'); });

            qs('add-todo-btn').addEventListener('click', addTask);
            qs('todo-input').addEventListener('keypress', (e)=>{ if(e.key === 'Enter') addTask(); });

            qs('add-grade-btn-modal').addEventListener('click', ()=> openModal('add-grade-modal'));
            qs('add-deadline-btn-modal').addEventListener('click', ()=> openModal('add-deadline-modal'));

            qs('export-json-btn').addEventListener('click', exportAllAsJSON);
            qs('import-json-input').addEventListener('change', (e)=>{ const f = e.target.files[0]; if(f) importFromFile(f); e.target.value = ''; });

            // render initial dates & content
            updateDisplay();
        });

        // expose some utilities for console/debug
        window._dashboard = { renderAll, getTasks, getGrades, getDeadlines };

    })();
    </script>
</body>
</html>